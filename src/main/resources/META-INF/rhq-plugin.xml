<?xml version="1.0" encoding="UTF-8" ?>

<plugin name="SQL Server" displayName="SQL Server Database"
	description="Management agent to query and monitor SQL Server" package="org.rhq.plugins.sqlserver"
	pluginLifecycleListener="MSSQLPluginLifecycleListener" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns="urn:xmlns:rhq-plugin" xmlns:c="urn:xmlns:rhq-configuration">

	<depends plugin="Database" useClasses="true" />

	<server name="Microsoft SQL Server" discovery="MSSQLDiscoveryComponent"
		class="MSSQLServerComponent" supportsManualAdd="true" description="SQL Server">

		<plugin-configuration>
			<c:simple-property name="instanceName" default="MSSQLSERVER"
				displayName="instance name" description="Optional instance name"
				required="false" />
			<c:simple-property name="host" default="127.0.0.1"
				displayName="listen host"
				description="the hostname or IP address that the database is listening on" />
			<c:simple-property name="port" default="1433"
				displayName="listen port" description="the TCP port that the database is listening on">
				<c:constraint>
					<c:integer-constraint minimum="1" maximum="65535" />
				</c:constraint>
			</c:simple-property>
			<c:simple-property name="db" default="master"
				displayName="database name" description="the name of the database to connect to" />

			<c:simple-property name="driverClass"
				default="com.microsoft.sqlserver.jdbc.SQLServerDriver" displayName="JDBC driver class"
				description="the fully-qualified classname of the JDBC driver class"
				required="false" />
			<c:simple-property name="principal" default="sa"
				displayName="role name" description="the database role to connect as" />
			<c:simple-property name="credentials" default="sa"
				type="password" displayName="role password"
				description="the password for the database role being used to connect" />
		</plugin-configuration>
		<process-scan name="windows" query="process|basename|match=^sqlservr.*" />

        <metric displayName="Version" property="productversion" dataType="trait" displayType="summary" description="SQL Server version info" />
        <metric displayName="Level" property="productlevel" dataType="trait" displayType="summary" description="SQL Server product level info" />
        <metric displayName="Edition" property="edition" dataType="trait" displayType="summary" description="SQL Server edition info" />
        <metric displayName="Max memory" property="max-memory" dataType="trait" displayType="summary" description="SQL Server max allowed memory configuration" />
        <metric displayName="XACT-resolution" property="xact-resolution" dataType="trait" displayType="summary" description="In-doubt XACT resolution configuration" />

		<service name="Database" class="MSSQLDatabaseComponent"
			discovery="MSSQLDatabaseDiscoveryComponent">
			<plugin-configuration>
				<c:simple-property name="databaseName"
					displayName="Database Name" readOnly="true" />
			</plugin-configuration>

            <metric displayName="Create time" property="create_date" dataType="trait" displayType="summary" description="Creation time of the database" />
            <metric displayName="Compatibility level" property="compatibility_level" dataType="trait" displayType="summary" description="Compatibility level of the database" />
            <metric displayName="Collation name" property="collation_name" dataType="trait" displayType="summary" description="Collation" />
            <metric displayName="State" property="state_desc" dataType="trait" displayType="summary" description="State of the database" />
            <metric displayName="Recovery model" property="recovery_model_desc" dataType="trait" displayType="summary" description="Recovery model" />
            <metric displayName="Database size" property="size" measurementType="dynamic" units="bytes" displayType="summary" description="Size of the database in KB" />

            <service name="Table" class="MSSQLTableComponent" discovery="MSSQLTableDiscoveryComponent"
				description="Database table">

				<plugin-configuration>
					<c:simple-property name="tableName" readOnly="true" />
				</plugin-configuration>

				<metric displayName="Reserved Size" property="reserved"
					measurementType="dynamic" displayType="summary" units="bytes"
					description="The reserved amount of data in KB" />
				<metric displayName="Data Size" property="data"
					measurementType="dynamic" displayType="summary" units="bytes"
					description="The amount of data currently stored in KB" />
				<metric displayName="Index Size" property="index_size"
					measurementType="dynamic" displayType="summary" units="bytes"
					description="The amount of data spent in indexes in KB" />
				<metric displayName="Unused" property="unused" measurementType="dynamic"
					displayType="summary" units="bytes"
					description="The amount of unused, but reserved space in KB" />
				<metric displayName="Rows" property="rows" measurementType="dynamic"
					defaultOn="false" description="The estimated count of rows in the table." />
			</service>

			<service name="Query" class="org.rhq.plugins.database.CustomTableComponent"
				discovery="org.rhq.plugins.database.CustomTableDiscoveryComponent"
				supportsManualAdd="true">

				<plugin-configuration>
					<c:simple-property name="table"
						description="The table to discover and to be queried on for metric data" />
					<c:simple-property name="name" required="false"
						description="Initial name of the resource when manually added. This is also part of the resource key - make this unique if you want two Query resources based on the same table." />
					<c:simple-property name="description" required="false"
						description="Initial description of resource when manually added" />
					<c:simple-property name="metricQuery" required="false"
						description="The query that will gather metric data. This must return two columns, a string column whose value is 'metricColumn' and then a numeric column whose value is the metric to be collected." />
				</plugin-configuration>

				<metric property="metricColumn" displayName="Metric Value"
					displayType="summary"
					description="The metric value for this Query. If Metric Query is not specified, this is not collected." />

			</service>
		</service>

	</server>

</plugin>
